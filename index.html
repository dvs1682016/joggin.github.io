<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸƒâ€â™‚ï¸ æ…¢è·‘ç´€éŒ„ (å¤šäººé›²ç«¯ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS æ¨£å¼ç¶­æŒå¤§åŒå°ç•°ï¼Œå¢åŠ äº†ç™»å…¥å€å¡Šçš„æ¨£å¼ */
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; background-color: #f0f2f5; }
        
        /* ç™»å…¥å€å¡Šå°ˆç”¨æ¨£å¼ */
        #authSection { max-width: 400px; margin: 5rem auto; text-align: center; }
        .auth-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; }
        .auth-btn.secondary { background: #666; margin-top: 10px; }
        
        /* App ä¸»ä»‹é¢ (é è¨­éš±è—) */
        #appSection { display: none; }
        
        /* é ‚éƒ¨å°è¦½åˆ— */
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { font-size: 0.9rem; color: #666; }
        .logout-btn { background: #ff4757; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer; }

        /* (ä¿ç•™ä¹‹å‰çš„æ¨£å¼...) */
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 2rem; border-top: 5px solid #4CAF50; }
        .card.editing { border-top: 5px solid #2196F3; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 1rem; }
        .form-group.full-width { grid-column: span 2; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555; }
        input { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 1rem; color: white; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; }
        #submitBtn { background-color: #4CAF50; }
        #submitBtn.update-mode { background-color: #2196F3; }
        #cancelBtn { background-color: #999; display: none; }
        .rating-container { display: flex; gap: 5px; cursor: pointer; font-size: 1.5rem; }
        .star { color: #ddd; }
        .star.selected { color: #ffc107; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f4f4f4; }
        .action-btn { padding: 5px 10px; font-size: 0.9rem; margin-right: 5px; width: auto; }
        .edit-btn { background-color: #2196F3; }
        .del-btn { background-color: #f44336; }
        
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .form-group.full-width { grid-column: span 1; } table { display: block; overflow-x: auto; white-space: nowrap; } }
    </style>
</head>
<body>

    <div id="authSection">
        <div class="auth-card">
            <h1>ğŸƒâ€â™‚ï¸ æ­¡è¿ä¾†åˆ°æ…¢è·‘ç´€éŒ„</h1>
            <p>è«‹å…ˆç™»å…¥ä»¥åŒæ­¥ä½ çš„æ•¸æ“š</p>
            <input type="email" id="email" class="auth-input" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)">
            <button class="auth-btn" onclick="handleLogin()">ç™»å…¥</button>
            <button class="auth-btn secondary" onclick="handleSignUp()">è¨»å†Šæ–°å¸³è™Ÿ</button>
            <p id="authMsg" style="color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="appSection">
        <div class="navbar">
            <div class="user-info">å—¨ï¼Œ<span id="userEmailDisplay">User</span> ğŸ‘‹</div>
            <button class="logout-btn" onclick="handleLogout()">ç™»å‡º</button>
        </div>

        <div class="card" id="inputCard">
            <h3 id="formTitle">æ–°å¢ç´€éŒ„</h3>
            <div class="form-grid">
                <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="dateInput"></div>
                <div class="form-group"><label>åœ°é»</label><input type="text" id="locationInput" placeholder="ä¾‹å¦‚: æ²³æ¿±å…¬åœ’"></div>
                <div class="form-group"><label>è·é›¢ (km)</label><input type="number" id="distanceInput" step="0.1"></div>
                <div class="form-group"><label>æ™‚é–“ (min)</label><input type="number" id="durationInput"></div>
                <div class="form-group full-width">
                    <label>æ»¿æ„åº¦</label>
                    <div class="rating-container" id="starRating">
                        <span class="star" data-value="1">â˜…</span><span class="star" data-value="2">â˜…</span>
                        <span class="star" data-value="3">â˜…</span><span class="star" data-value="4">â˜…</span>
                        <span class="star" data-value="5">â˜…</span>
                    </div>
                    <input type="hidden" id="feelingValue" value="0">
                </div>
            </div>
            <div class="btn-group">
                <button id="submitBtn" onclick="handleFormSubmit()">æ–°å¢ç´€éŒ„</button>
                <button id="cancelBtn" onclick="resetForm()">å–æ¶ˆä¿®æ”¹</button>
            </div>
        </div>

        <table id="logsTable">
            <thead><tr><th>æ—¥æœŸ</th><th>è·é›¢/æ™‚é–“</th><th>åœ°é»</th><th>æ»¿æ„åº¦</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
        <p id="loadingText" style="text-align: center; color: #888;">è¼‰å…¥ä¸­...</p>
    </div>

    <script>
        // è¨­å®šå€
       const SUPABASE_URL = 'https://jizwmppcyjyhmrvrdwqi.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppendtcHBjeWp5aG1ydnJkd3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NjA3MTAsImV4cCI6MjA3NjEzNjcxMH0.H5I0Z-l9cA7g39ZhwAKJ25Y9svIuL86HCqGnNL4ADzM'; 
 
        const dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentLogsData = [];
        let editingId = null;

        // ==========================================
        // 1. Auth ç‹€æ…‹ç›£è½ (æœ€é‡è¦ï¼)
        // ==========================================
        // åªè¦ç™»å…¥ç‹€æ…‹æ”¹è®Š (ç™»å…¥/ç™»å‡º)ï¼Œé€™è£¡å°±æœƒåŸ·è¡Œ
        dbClient.auth.onAuthStateChange((event, session) => {
            if (session) {
                // å·²ç™»å…¥
                currentUser = session.user;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'block';
                document.getElementById('userEmailDisplay').innerText = currentUser.email;
                fetchLogs(); // è¼‰å…¥è³‡æ–™
            } else {
                // æœªç™»å…¥
                currentUser = null;
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('appSection').style.display = 'none';
            }
        });

        // ==========================================
        // 2. ç™»å…¥èˆ‡è¨»å†Šé‚è¼¯
        // ==========================================
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await dbClient.auth.signInWithPassword({ email, password });
            if (error) document.getElementById('authMsg').innerText = error.message;
        }

        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await dbClient.auth.signUp({ email, password });
            if (error) {
                document.getElementById('authMsg').innerText = error.message;
            } else {
                alert("è¨»å†ŠæˆåŠŸï¼å¦‚æœæ²’è‡ªå‹•ç™»å…¥ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰æ”¶åˆ°é©—è­‰ä¿¡ï¼Œæˆ–ç›´æ¥ç™»å…¥ã€‚");
            }
        }

        async function handleLogout() {
            const { error } = await dbClient.auth.signOut();
            if (error) alert(error.message);
        }

        // ==========================================
        // 3. è³‡æ–™åº«æ“ä½œ (å®Œå…¨ä¸ç”¨æ”¹ï¼RLS æœƒè‡ªå‹•è™•ç†)
        // ==========================================
        async function fetchLogs() {
            const tbody = document.getElementById('tableBody');
            const loading = document.getElementById('loadingText');
            loading.style.display = 'block';
            tbody.innerHTML = '';

            // â˜…é€™è£¡å®Œå…¨ä¸ç”¨å‚³ user_idï¼ŒSupabase æœƒè‡ªå·±çŸ¥é“ä½ æ˜¯èª°ï¼Œåªçµ¦ä½ ä½ çš„è³‡æ–™â˜…
            const { data, error } = await dbClient
                .from('jogging_logs')
                .select('*')
                .order('created_at', { ascending: false });

            loading.style.display = 'none';
            if (error) { console.error(error); return; }
            currentLogsData = data;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»è·‘ä¸€è·‘ï¼</td></tr>';
                return;
            }

            data.forEach(log => {
                const score = parseInt(log.feeling) || 0;
                const starsDisplay = 'â­'.repeat(score);
                const row = `
                    <tr>
                        <td>${log.run_date}</td>
                        <td>${log.distance_km}km / ${log.duration_min}min</td>
                        <td>${log.location || '-'}</td>
                        <td style="color: #ffc107;">${starsDisplay}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="startEdit(${log.id})">ä¿®æ”¹</button>
                            <button class="action-btn del-btn" onclick="deleteLog(${log.id})">åˆªé™¤</button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function handleFormSubmit() {
            const date = document.getElementById('dateInput').value;
            const dist = document.getElementById('distanceInput').value;
            const dur = document.getElementById('durationInput').value;
            const loc = document.getElementById('locationInput').value;
            const feel = document.getElementById('feelingValue').value;

            if (!date || !dist || !dur) { alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }

            const payload = { run_date: date, distance_km: dist, duration_min: dur, location: loc, feeling: feel };

            let error = null;
            if (editingId) {
                const res = await dbClient.from('jogging_logs').update(payload).eq('id', editingId);
                error = res.error;
            } else {
                // â˜…é€™è£¡ä¹Ÿä¸ç”¨å‚³ user_idï¼Œè³‡æ–™åº«é è¨­å€¼(default auth.uid())æœƒè‡ªå‹•å¡«å…¥â˜…
                const res = await dbClient.from('jogging_logs').insert(payload);
                error = res.error;
            }

            if (error) { alert('æ“ä½œå¤±æ•—: ' + error.message); } 
            else { alert(editingId ? 'ä¿®æ”¹æˆåŠŸ' : 'æ–°å¢æˆåŠŸ'); resetForm(); fetchLogs(); }
        }

        async function deleteLog(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            const { error } = await dbClient.from('jogging_logs').delete().eq('id', id);
            if (!error) fetchLogs();
        }

        // --- è¼”åŠ©åŠŸèƒ½ (UIæ“ä½œ) ---
        function startEdit(id) {
            const log = currentLogsData.find(i => i.id === id);
            if (!log) return;
            document.getElementById('dateInput').value = log.run_date;
            document.getElementById('distanceInput').value = log.distance_km;
            document.getElementById('durationInput').value = log.duration_min;
            document.getElementById('locationInput').value = log.location;
            document.getElementById('feelingValue').value = parseInt(log.feeling)||0;
            updateStars(parseInt(log.feeling)||0);
            
            editingId = id;
            document.getElementById('formTitle').innerText = 'âœï¸ ä¿®æ”¹ç´€éŒ„';
            document.getElementById('inputCard').classList.add('editing');
            document.getElementById('submitBtn').innerText = 'å„²å­˜ä¿®æ”¹';
            document.getElementById('submitBtn').classList.add('update-mode');
            document.getElementById('cancelBtn').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('dateInput').valueAsDate = new Date();
            document.getElementById('distanceInput').value = '';
            document.getElementById('durationInput').value = '';
            document.getElementById('locationInput').value = '';
            document.getElementById('feelingValue').value = 0;
            updateStars(0);
            editingId = null;
            document.getElementById('formTitle').innerText = 'æ–°å¢ç´€éŒ„';
            document.getElementById('inputCard').classList.remove('editing');
            document.getElementById('submitBtn').innerText = 'æ–°å¢ç´€éŒ„';
            document.getElementById('submitBtn').classList.remove('update-mode');
            document.getElementById('cancelBtn').style.display = 'none';
        }

        const stars = document.querySelectorAll('#starRating .star');
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const val = this.getAttribute('data-value');
                document.getElementById('feelingValue').value = val;
                updateStars(val);
            });
        });
        function updateStars(val) {
            stars.forEach(s => s.classList.toggle('selected', s.getAttribute('data-value') <= val));
        }

        // åˆå§‹åŒ–
        document.getElementById('dateInput').valueAsDate = new Date();
    </script>
</body>
</html>