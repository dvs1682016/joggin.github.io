<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ…¢è·‘ç´€éŒ„ç°¿ (å®Œæ•´CRUDç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- æ¨£å¼è¨­å®š (èˆ‡ä¹‹å‰ç›¸åŒï¼Œæ–°å¢æŒ‰éˆ•æ¨£å¼) --- */
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 2rem; border-top: 5px solid #4CAF50; transition: border-color 0.3s; }
        .card.editing { border-top-color: #FF9800; /* ç·¨è¼¯æ¨¡å¼è®Šæ©˜è‰² */ }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 1rem; }
        .form-group.full-width { grid-column: span 2; }
        
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555; }
        input { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { grid-column: span 2; display: flex; gap: 10px; }
        button { flex: 1; padding: 1rem; color: white; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; transition: background 0.3s; }
        
        /* å„ç¨®æŒ‰éˆ•é¡è‰² */
        #submitBtn { background-color: #4CAF50; } /* ç¶ è‰²ï¼šæ–°å¢ */
        #submitBtn.update-mode { background-color: #FF9800; } /* æ©˜è‰²ï¼šæ›´æ–° */
        #cancelBtn { background-color: #999; display: none; } /* ç°è‰²ï¼šå–æ¶ˆ */
        
        button:hover { opacity: 0.9; }

        /* æ˜Ÿæ˜Ÿè©•åˆ† */
        .rating-container { display: flex; gap: 5px; cursor: pointer; font-size: 1.5rem; }
        .star { color: #ddd; transition: color 0.2s; }
        .star.selected { color: #ffc107; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f4f4f4; color: #333; font-weight: bold; }
        tr:hover { background-color: #f9f9f9; }
        
        /* è¡¨æ ¼æ“ä½œæŒ‰éˆ• */
        .action-btn { padding: 5px 10px; font-size: 0.9rem; margin-right: 5px; width: auto; display: inline-block; }
        .edit-btn { background-color: #2196F3; } /* è—è‰² */
        .del-btn { background-color: #F44336; } /* ç´…è‰² */

        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease-out; }
        .modal-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .modal-btn { background-color: #2196F3; margin-top: 20px; width: auto; padding: 8px 25px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .form-group.full-width, .btn-group { grid-column: span 1; } table { display: block; overflow-x: auto; white-space: nowrap; } }
    </style>
</head>
<body>

    <h1>ğŸƒâ€â™‚ï¸ æ…¢è·‘ç´€éŒ„ç°¿ (å®Œæ•´ç‰ˆ)</h1>

    <div class="card" id="inputCard">
        <div class="form-grid">
            <input type="hidden" id="currentId">
            
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="dateInput">
            </div>
            <div class="form-group">
                <label>åœ°é»</label>
                <input type="text" id="locationInput" placeholder="ä¾‹å¦‚: æ²³æ¿±å…¬åœ’">
            </div>
            <div class="form-group">
                <label>è·é›¢ (å…¬é‡Œ)</label>
                <input type="number" id="distanceInput" step="0.1" placeholder="0.0">
            </div>
            <div class="form-group">
                <label>æ™‚é–“ (åˆ†é˜)</label>
                <input type="number" id="durationInput" placeholder="0">
            </div>
            <div class="form-group full-width">
                <label>è‡ªæˆ‘æ»¿æ„åº¦ (1~5é¡†å¿ƒ)</label>
                <div class="rating-container" id="starRating">
                    <span class="star" data-value="1">â˜…</span>
                    <span class="star" data-value="2">â˜…</span>
                    <span class="star" data-value="3">â˜…</span>
                    <span class="star" data-value="4">â˜…</span>
                    <span class="star" data-value="5">â˜…</span>
                </div>
                <input type="hidden" id="feelingValue" value="0"> 
            </div>
            
            <div class="btn-group">
                <button id="submitBtn" onclick="handleSubmit()">æ–°å¢ç´€éŒ„</button>
                <button id="cancelBtn" onclick="resetForm()">å–æ¶ˆä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <table id="logsTable">
        <thead>
            <tr>
                <th>æ—¥æœŸ</th>
                <th>è·é›¢ (km)</th>
                <th>æ™‚é–“ (min)</th>
                <th>åœ°é»</th>
                <th>æ»¿æ„åº¦</th>
                <th>æ“ä½œ</th> </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <p id="loadingText" style="text-align: center; color: #888;">è¼‰å…¥ä¸­...</p>

    <div id="successModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-icon">ğŸ‰</span>
            <h3 id="modalTitle">æ“ä½œæˆåŠŸï¼</h3>
            <button class="modal-btn" onclick="closeModal()">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. è¨­å®š Supabase (è«‹å¡«å…¥ä½ çš„ Key)
        // ==========================================
        const SUPABASE_URL = 'https://jizwmppcyjyhmrvrdwqi.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppendtcHBjeWp5aG1ydnJkd3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NjA3MTAsImV4cCI6MjA3NjEzNjcxMH0.H5I0Z-l9cA7g39ZhwAKJ25Y9svIuL86HCqGnNL4ADzM'; 

        const dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ç”¨ä¸€å€‹å…¨åŸŸè®Šæ•¸ä¾†å­˜ç›®å‰æŠ“åˆ°çš„æ‰€æœ‰è³‡æ–™ï¼Œæ–¹ä¾¿ç·¨è¼¯æ™‚å–ç”¨
        let allLogsData = [];

        // ==========================================
        // 2. æ˜Ÿæ˜Ÿè©•åˆ†é‚è¼¯
        // ==========================================
        const stars = document.querySelectorAll('#starRating .star');
        const feelingInput = document.getElementById('feelingValue');

        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                feelingInput.value = value; 
                updateStarsUI(value);
            });
        });

        function updateStarsUI(value) {
            stars.forEach(s => {
                if (s.getAttribute('data-value') <= value) s.classList.add('selected');
                else s.classList.remove('selected');
            });
        }

        // ==========================================
        // 3. è®€å–è³‡æ–™ (Read)
        // ==========================================
        async function fetchLogs() {
            const tbody = document.getElementById('tableBody');
            const loading = document.getElementById('loadingText');
            loading.style.display = 'block';
            tbody.innerHTML = '';

            // ä¾ç…§ created_at é™åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
            const { data, error } = await dbClient
                .from('jogging_logs')
                .select('*')
                .order('created_at', { ascending: false });

            loading.style.display = 'none';

            if (error) {
                console.error(error);
                alert('è®€å–å¤±æ•—: ' + error.message);
                return;
            }

            allLogsData = data; // å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾›ç·¨è¼¯æ™‚æŸ¥æ‰¾

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>';
                return;
            }

            data.forEach(log => {
                const score = parseInt(log.feeling) || 0; 
                const starsDisplay = 'â­'.repeat(score); 

                const row = `
                    <tr>
                        <td>${log.run_date}</td>
                        <td>${log.distance_km}</td>
                        <td>${log.duration_min}</td>
                        <td>${log.location || '-'}</td>
                        <td style="color: #ffc107;">${starsDisplay}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="startEdit(${log.id})">ä¿®æ”¹</button>
                            <button class="action-btn del-btn" onclick="deleteLog(${log.id})">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ==========================================
        // 4. æäº¤è¡¨å–® (åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯æ›´æ–°)
        // ==========================================
        async function handleSubmit() {
            const currentId = document.getElementById('currentId').value;
            const date = document.getElementById('dateInput').value;
            const dist = document.getElementById('distanceInput').value;
            const dur = document.getElementById('durationInput').value;
            const loc = document.getElementById('locationInput').value;
            const feel = document.getElementById('feelingValue').value;

            if (!date || !dist || !dur) {
                alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                return;
            }

            const payload = {
                run_date: date,
                distance_km: dist,
                duration_min: dur,
                location: loc,
                feeling: feel
            };

            let error = null;

            if (currentId) {
                // --- æ›´æ–°æ¨¡å¼ (Update) ---
                console.log("æ­£åœ¨æ›´æ–° ID:", currentId);
                const response = await dbClient
                    .from('jogging_logs')
                    .update(payload)
                    .eq('id', currentId);
                error = response.error;
            } else {
                // --- æ–°å¢æ¨¡å¼ (Create) ---
                console.log("æ­£åœ¨æ–°å¢è³‡æ–™");
                const response = await dbClient
                    .from('jogging_logs')
                    .insert(payload);
                error = response.error;
            }

            if (error) {
                alert('æ“ä½œå¤±æ•—: ' + error.message);
            } else {
                showModal(currentId ? "ä¿®æ”¹æˆåŠŸï¼" : "æ–°å¢æˆåŠŸï¼");
                resetForm(); // é‡ç½®è¡¨å–®
                fetchLogs(); // é‡æ–°æ•´ç†è¡¨æ ¼
            }
        }

        // ==========================================
        // 5. å•Ÿå‹•ç·¨è¼¯æ¨¡å¼
        // ==========================================
        function startEdit(id) {
            // å¾æˆ‘å€‘å­˜å¥½çš„ allLogsData ä¸­æ‰¾åˆ°é€™ç­†è³‡æ–™
            const log = allLogsData.find(item => item.id === id);
            if (!log) return;

            // 1. æŠŠè³‡æ–™å¡«å›è¼¸å…¥æ¡†
            document.getElementById('currentId').value = log.id;
            document.getElementById('dateInput').value = log.run_date;
            document.getElementById('distanceInput').value = log.distance_km;
            document.getElementById('durationInput').value = log.duration_min;
            document.getElementById('locationInput').value = log.location;
            document.getElementById('feelingValue').value = log.feeling;
            updateStarsUI(log.feeling);

            // 2. æ”¹è®Šä»‹é¢ç‹€æ…‹ (è®“ä½¿ç”¨è€…çŸ¥é“ç¾åœ¨æ˜¯ç·¨è¼¯æ¨¡å¼)
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerText = "ç¢ºèªä¿®æ”¹"; // æ”¹æŒ‰éˆ•æ–‡å­—
            submitBtn.classList.add('update-mode'); // æ”¹æŒ‰éˆ•é¡è‰²
            
            document.getElementById('cancelBtn').style.display = 'block'; // é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ•
            document.getElementById('inputCard').classList.add('editing'); // å¡ç‰‡è®Šè‰²
            
            // 3. æ²å‹•åˆ°æœ€ä¸Šé¢
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // 6. åˆªé™¤è³‡æ–™ (Delete)
        // ==========================================
        async function deleteLog(id) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸå–”ï¼")) {
                return;
            }

            const { error } = await dbClient
                .from('jogging_logs')
                .delete()
                .eq('id', id);

            if (error) {
                alert("åˆªé™¤å¤±æ•—: " + error.message);
            } else {
                fetchLogs(); // é‡æ–°æ•´ç†
            }
        }

        // ==========================================
        // 7. é‡ç½®è¡¨å–® (å›åˆ°æ–°å¢æ¨¡å¼)
        // ==========================================
        function resetForm() {
            document.getElementById('currentId').value = '';
            document.getElementById('distanceInput').value = '';
            document.getElementById('durationInput').value = '';
            document.getElementById('locationInput').value = '';
            document.getElementById('feelingValue').value = '0';
            updateStarsUI(0);

            // ä»‹é¢é‚„åŸ
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerText = "æ–°å¢ç´€éŒ„";
            submitBtn.classList.remove('update-mode');
            
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('inputCard').classList.remove('editing');
        }

        // å½ˆçª—æ§åˆ¶
        function showModal(msg) {
            document.getElementById('modalTitle').innerText = msg;
            document.getElementById('successModal').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        // åˆå§‹åŒ–
        document.getElementById('dateInput').valueAsDate = new Date();
        fetchLogs();

    </script>
</body>
</html>